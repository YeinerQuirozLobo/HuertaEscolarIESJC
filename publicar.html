// -------------------- Referencias --------------------
const db = firebase.firestore();
const storage = firebase.storage();

const displayNameEl = document.getElementById('displayName');
const productNameEl = document.getElementById('productName');
const productQtyEl = document.getElementById('productQty');
const desiredEl = document.getElementById('desired');
const desiredQtyEl = document.getElementById('desiredQty');
const productImageEl = document.getElementById('productImage');
const publishBtn = document.getElementById('publishBtn');
const productsList = document.getElementById('productsList');

// -------------------- Publicar producto --------------------
publishBtn.onclick = async () => {
  const ownerName = displayNameEl.value.trim();
  const name = productNameEl.value.trim();
  const qty = productQtyEl.value.trim();
  const desired = desiredEl.value.trim();
  const desiredQty = desiredQtyEl.value.trim();
  const file = productImageEl.files[0];

  if (!ownerName || !name || !qty || !desired || !desiredQty || !file) {
    alert("‚ö†Ô∏è Completa todos los campos y selecciona una imagen.");
    return;
  }

  try {
    publishBtn.disabled = true;
    publishBtn.innerText = "Publicando...";

    // Subir imagen
    const filePath = `products/${Date.now()}_${file.name.replace(/\s+/g, "_")}`;
    const uploadSnap = await storage.ref(filePath).put(file);
    const imageUrl = await uploadSnap.ref.getDownloadURL();

    // Guardar en Firestore
    await db.collection("products").add({
      ownerName,
      name,
      qty,
      desired,
      desiredQty,
      imageUrl,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Limpiar formulario
    productNameEl.value = "";
    productQtyEl.value = "";
    desiredEl.value = "";
    desiredQtyEl.value = "";
    productImageEl.value = "";
    alert("‚úÖ Producto publicado con √©xito");

  } catch (error) {
    console.error("Error al publicar:", error);
    alert("‚ùå Error al publicar: " + error.message);
  } finally {
    publishBtn.disabled = false;
    publishBtn.innerText = "Publicar";
  }
};

// -------------------- Mostrar productos en tiempo real --------------------
function loadProducts() {
  db.collection("products").orderBy("createdAt", "desc").onSnapshot(snapshot => {
    productsList.innerHTML = "";

    if (snapshot.empty) {
      productsList.innerHTML = "<p class='text-muted'>No hay productos a√∫n.</p>";
      return;
    }

    snapshot.forEach(doc => {
      const data = doc.data();
      const productEl = document.createElement("div");
      productEl.className = "product-card";

      productEl.innerHTML = `
        <img src="${data.imageUrl}" alt="${data.name}">
        <div class="product-info flex-grow-1">
          <h5>${data.name} <small>(${data.qty})</small></h5>
          <p><strong>${data.ownerName}</strong></p>
          <p>Desea: ${data.desired} (${data.desiredQty})</p>
          <button class="btn btn-sm btn-outline-primary contactBtn">Contactar</button>
          <button class="btn btn-sm btn-outline-danger deleteBtn">Eliminar</button>
        </div>
      `;

      // --- Bot√≥n Contactar ---
      productEl.querySelector(".contactBtn").onclick = () => {
        alert(`üì© Para contactar con ${data.ownerName}, por ahora debes hablar en persona o dentro de la instituci√≥n (m√°s adelante podemos poner correos).`);
      };

      // --- Bot√≥n Eliminar ---
      productEl.querySelector(".deleteBtn").onclick = async () => {
        const confirmDelete = confirm(`¬øSeguro que deseas eliminar el producto "${data.name}"?`);
        if (!confirmDelete) return;

        try {
          // 1. Eliminar imagen del storage
          if (data.imageUrl) {
            const imageRef = storage.refFromURL(data.imageUrl);
            await imageRef.delete();
          }

          // 2. Eliminar documento en Firestore
          await db.collection("products").doc(doc.id).delete();

          alert("‚úÖ Producto eliminado con √©xito");
        } catch (err) {
          console.error("Error al eliminar:", err);
          alert("‚ùå Error al eliminar: " + err.message);
        }
      };

      productsList.appendChild(productEl);
    });
  });
}
